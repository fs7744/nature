worker_processes: 1
enable_reuseport: true
events_sock: unix:/tmp/event.sock
error_log_level: info
dns:
  enable_ipv6: false
  timeout: 500
  validTtl: 60000
  retrans: 1
  nameservers:
    - 10.16.73.7
    - 10.16.83.7
    - 10.16.42.7
discovery:
  - dns
  - static
plugins:
  stream:
    - nature.plugins.single_upstream
  http:
    - nature.plugins.single_upstream
    - nature.plugins.waf
stream:
  enable: true
  access_log:
    enable: true
    format: "$remote_addr [$time_local] $protocol $status $bytes_sent $bytes_received $session_time $hostname $server_addr"
http:
  enable: true
  access_log:
    enable: true
    format: "$remote_addr [$time_local] $status $request_time $upstream_status $upstream_addr $upstream_response_time $upstream_uri $upstream_scheme"
  listens:
    - listen: 127.0.0.1:8981
router:
  l4:
    r1:
      host:
        - *
      listen: 127.0.0.1:8980
      type: tcp
      ssl: false
      upstream: a
      preread:
        - name: nature.plugins.single_upstream
  l7:
    r2:
      host:
        - edge.newegg.lt
      paths:
        - *
      upstream: a
      access:
        - name: nature.plugins.single_upstream
        - name: nature.plugins.waf
          waf:
            rules:
              - java.lang
              - .(htaccess|bash_history)
            vars:
              - uri
              - http_user_agent
              - http_cookie
upstream:
  a:
    lb: roundrobin
    nodes:
      - host: edge.newegg.lt
        port: 80
        weight: 1
        discovery: dns
      - host: 172.16.150.156
        port: 820
        weight: 1
        discovery: static
    healthcheck:
      is_passive: true
      type: http
      path: /faq
      #header: "Host: edge.newegg.lt\r\n"
      match_body: faq

